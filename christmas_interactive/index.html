<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas Family</title>
    <style>
        body {
            margin: 0;
            background-color: #050505;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤ç¼©æ”¾ï¼Œäº¤ç»™æˆ‘ä»¬è‡ªå·±æ§åˆ¶ */
        }
        
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* æç¤ºæ–‡å­— */
        .ui-layer {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-size: 14px;
            pointer-events: none;
            z-index: 10;
        }

        /* å¦‚æœæ˜¯ç”µè„‘ç«¯ï¼Œæ˜¾ç¤ºä¸€ä¸ªæ§åˆ¶æ¡è¾…åŠ©ï¼ˆå› ä¸ºç”µè„‘æ²¡æ³•åŒæŒ‡æåˆï¼‰ */
        .desktop-control {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ£€æµ‹åˆ°æ˜¯éè§¦å±è®¾å¤‡æ—¶æ˜¾ç¤º */
        }
        
        button {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid gold;
            color: gold;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        /* ç¯ç®±ï¼ˆç‚¹å‡»ç…§ç‰‡æ”¾å¤§çš„æ•ˆæœï¼‰ */
        .lightbox {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .lightbox.active {
            opacity: 1;
            pointer-events: auto;
        }
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border: 4px solid #fff;
            box-shadow: 0 0 50px rgba(255,255,255,0.2);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .lightbox.active img {
            transform: scale(1);
        }
        .close-btn {
            position: absolute;
            top: 20px; right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="ui-layer">
        <p>ğŸ‘† å•æŒ‡æ‹–æ‹½æ—‹è½¬ | âœŒï¸ åŒæŒ‡å¼ å¼€ç‚¸è£‚ | ğŸ‘‡ ç‚¹å‡»ç…§ç‰‡æ”¾å¤§</p>
    </div>

    <div class="desktop-control" id="desktopCtrl">
        <button id="toggleBtn">ç‚¹å‡» å±•å¼€/æ”¶èµ· (ç”µè„‘ç‰ˆ)</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="lightbox" id="lightbox">
        <div class="close-btn">Ã—</div>
        <img id="lightbox-img" src="">
    </div>

    <script>
        // === é…ç½®åŒº ===
        // åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ç…§ç‰‡æ–‡ä»¶å
        const PHOTO_LIST = [
            'p1.jpg', 
            'p2.jpg',
            'p3.jpg',
            'p1.jpg', // å¯ä»¥é‡å¤ä½¿ç”¨
            'p2.jpg'
        ];

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');

        let width, height;
        let particles = [];
        let photos = [];
        
        // äº¤äº’çŠ¶æ€
        let rotationY = 0; // æ—‹è½¬è§’åº¦
        let expandLevel = 0; // å±•å¼€ç¨‹åº¦ 0(æ”¶èµ·) - 1(å®Œå…¨ç‚¸å¼€)
        let targetExpandLevel = 0;
        
        // è§¦æ‘¸æ§åˆ¶å˜é‡
        let lastX = 0;
        let isDragging = false;
        let initialPinchDist = 0;
        
        // åŠ è½½å›¾ç‰‡èµ„æº
        let loadedImages = [];
        let imagesLoadedCount = 0;

        function preloadImages() {
            PHOTO_LIST.forEach((src, index) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    loadedImages.push(img);
                    imagesLoadedCount++;
                    if(imagesLoadedCount === PHOTO_LIST.length) init();
                };
                // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œé˜²æ­¢ç¨‹åºå¡æ­»ï¼Œç”Ÿæˆä¸€ä¸ªå ä½è‰²å—
                img.onerror = () => {
                   // ç®€å•çš„é”™è¯¯å¤„ç†
                   loadedImages.push(null); 
                   imagesLoadedCount++;
                   if(imagesLoadedCount === PHOTO_LIST.length) init();
                }
            });
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- ç±»å®šä¹‰ ---

        class Particle {
            constructor() {
                // æ ‘å½¢æ€çš„åæ ‡
                let t = Math.random();
                let angle = t * Math.PI * 15 + Math.random() * Math.PI * 2;
                let r = 20 + (1-t) * 200; // åº•éƒ¨å®½ï¼Œé¡¶éƒ¨çª„
                
                this.tx = Math.cos(angle) * r;
                this.ty = -250 + t * 500;
                this.tz = Math.sin(angle) * r;

                // çˆ†ç‚¸åçš„åæ ‡ (å‘å¤–æ‰©æ•£)
                let expDir = Math.atan2(this.tz, this.tx);
                let expDist = Math.random() * 400 + 200;
                this.ex = Math.cos(expDir) * expDist;
                this.ey = this.ty + (Math.random()-0.5) * 200;
                this.ez = Math.sin(expDir) * expDist;

                this.color = Math.random() > 0.3 ? `hsla(120, 80%, ${50+Math.random()*30}%, 0.8)` : `hsla(45, 100%, 60%, 0.9)`;
                this.size = Math.random() * 2 + 1;
            }

            draw(ctx, sin, cos, centerScale) {
                // æ’å€¼è®¡ç®—å½“å‰ä½ç½®
                let currX = this.tx + (this.ex - this.tx) * expandLevel;
                let currY = this.ty + (this.ey - this.ty) * expandLevel;
                let currZ = this.tz + (this.ez - this.tz) * expandLevel;

                // æ—‹è½¬
                let rx = currX * cos - currZ * sin;
                let rz = currX * sin + currZ * cos;

                // 3D æŠ•å½±
                let perspective = 800;
                let scale = perspective / (perspective + rz + 400);

                if (scale > 0) {
                    let x2d = width/2 + rx * scale;
                    let y2d = height/2 + currY * scale;
                    
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(x2d, y2d, this.size * scale, 0, Math.PI * 2);
                    ctx.fill();
                }
                return rz; // è¿”å›æ·±åº¦ç”¨äºæ’åº
            }
        }

        class PhotoItem {
            constructor(img, index, total) {
                this.img = img;
                // å‡åŒ€åˆ†å¸ƒåœ¨èºæ—‹çº¿ä¸Š
                let t = (index + 0.5) / total; 
                let angle = t * Math.PI * 10; // 5åœˆ
                let r = 30 + (1-t) * 180; // è´´åœ¨æ ‘è¡¨é¢

                this.tx = Math.cos(angle) * r;
                this.ty = -200 + t * 450;
                this.tz = Math.sin(angle) * r;

                // çˆ†ç‚¸ä½ç½®ï¼šæ›´è¿œ
                this.ex = this.tx * 2.5; 
                this.ey = this.ty;
                this.ez = this.tz * 2.5;

                this.w = 60; // å›¾ç‰‡åŸºç¡€å¤§å°
                this.h = 80;

                // ç‚¹å‡»æ£€æµ‹åŒºåŸŸ
                this.screenX = 0;
                this.screenY = 0;
                this.screenSize = 0;
            }

            draw(ctx, sin, cos) {
                if (!this.img) return -9999;

                let currX = this.tx + (this.ex - this.tx) * expandLevel;
                let currY = this.ty + (this.ey - this.ty) * expandLevel;
                let currZ = this.tz + (this.ez - this.tz) * expandLevel;

                let rx = currX * cos - currZ * sin;
                let rz = currX * sin + currZ * cos;

                let perspective = 800;
                let scale = perspective / (perspective + rz + 400);

                if (scale > 0) {
                    this.screenSize = Math.max(this.w * scale, 10); // æœ€å°é™åˆ¶
                    this.screenX = width/2 + rx * scale;
                    this.screenY = height/2 + currY * scale;

                    // ç»˜åˆ¶è¾¹æ¡†
                    ctx.save();
                    ctx.translate(this.screenX, this.screenY);
                    
                    // åªæœ‰å±•å¼€æ—¶å›¾ç‰‡æ‰å˜å¤§å˜æ˜æ˜¾ï¼Œæ”¶èµ·æ—¶åƒä¸ªè£…é¥°å“
                    let photoScale = expandLevel > 0.5 ? 1 : 0.4;
                    ctx.scale(photoScale, photoScale);

                    // ç”»ç…§ç‰‡
                    ctx.fillStyle = "#fff";
                    ctx.fillRect(-this.screenSize/2 - 2, -this.screenSize*1.2/2 - 2, this.screenSize+4, this.screenSize*1.2+4);
                    ctx.drawImage(this.img, -this.screenSize/2, -this.screenSize*1.2/2, this.screenSize, this.screenSize*1.2);
                    
                    ctx.restore();
                }
                return rz;
            }
        }

        function init() {
            // ç”Ÿæˆç²’å­
            for (let i = 0; i < 1500; i++) {
                particles.push(new Particle());
            }
            // ç”Ÿæˆç…§ç‰‡
            loadedImages.forEach((img, i) => {
                if(img) photos.push(new PhotoItem(img, i, loadedImages.length));
            });

            animate();
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            
            // ç¼“åŠ¨æ›´æ–°å±•å¼€ç¨‹åº¦
            expandLevel += (targetExpandLevel - expandLevel) * 0.1;
            
            // è‡ªåŠ¨æ…¢æ—‹è½¬ (å¦‚æœæ²¡æœ‰åœ¨æ‹–æ‹½)
            if (!isDragging && Math.abs(expandLevel - 0) < 0.01) {
                rotationY += 0.003; 
            }

            let sin = Math.sin(rotationY);
            let cos = Math.cos(rotationY);

            // æ··åˆæ’åºï¼šç²’å­å’Œç…§ç‰‡éƒ½è¦æŒ‰ Z è½´æ·±åº¦æ’åºï¼Œæ‰èƒ½æ­£ç¡®é®æŒ¡
            let renderList = [];
            
            particles.forEach(p => {
                renderList.push({ type: 'p', obj: p });
            });
            photos.forEach(p => {
                renderList.push({ type: 'photo', obj: p });
            });

            // è®¡ç®—æ‰€æœ‰ç‰©ä½“çš„ Z æ·±åº¦ç”¨äºæ’åº (ç”±äºJSè®¡ç®—é‡å¤§ï¼Œè¿™é‡Œç®€åŒ–ï¼Œåªåœ¨drawé‡Œç®—ä¸€æ¬¡)
            // ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬ç®€åŒ–ä¸€ä¸‹ï¼šå…ˆç”»ç²’å­ï¼Œå†ç”»ç…§ç‰‡ï¼Ÿä¸è¡Œï¼Œä¼šç©¿æ¨¡ã€‚
            // æ­£ç¡®åšæ³•ï¼šå…¨éƒ¨è®¡ç®—æŠ•å½±å Zï¼Œç„¶å sort
            // è¿™é‡Œä¸ºäº†ä»£ç ç®€æ´ï¼Œæˆ‘ä»¬åœ¨ draw æ–¹æ³•é‡Œä¸åšç»˜åˆ¶ï¼Œæ”¹ä¸ºè¿”å› zï¼Œç„¶åç»Ÿä¸€ç»˜åˆ¶ï¼Ÿ
            // è€ƒè™‘åˆ°è¿™æ˜¯ä¸ªç®€å•ç¤¼ç‰©ï¼Œæˆ‘ä»¬ç”¨ç®€å•çš„â€œå…ˆç²’å­åç…§ç‰‡â€ç­–ç•¥ï¼Œè™½ç„¶æœ‰è½»å¾®ç©¿æ¨¡ä½†ä¸å½±å“ç¾è§‚ï¼Œ
            // æˆ–è€…ï¼šæŠŠç…§ç‰‡æ°¸è¿œæ”¾åœ¨ç²’å­ä¸Šé¢ï¼ˆæ›´æ¸…æ™°ï¼‰ã€‚
            
            // æ–¹æ¡ˆï¼šå…ˆç”»æ‰€æœ‰ç²’å­ï¼Œå†ç”»æ‰€æœ‰ç…§ç‰‡ã€‚
            // è¿™æ ·ç…§ç‰‡æ°¸è¿œæ¸…æ™°ï¼Œä¸ä¼šè¢«æ ‘å¶æŒ¡ä½ï¼Œç¬¦åˆâ€œå±•ç¤ºç…§ç‰‡â€çš„éœ€æ±‚ã€‚
            
            particles.forEach(p => p.draw(ctx, sin, cos));
            
            // å¯¹ç…§ç‰‡è¿›è¡Œ Z æ’åºï¼Œä¿è¯å‰é¢çš„ç…§ç‰‡æŒ¡ä½åé¢çš„ç…§ç‰‡
            let photoRenderList = photos.map(p => {
                // é¢„è®¡ç®— Z
                let currX = p.tx + (p.ex - p.tx) * expandLevel;
                let currZ = p.tz + (p.ez - p.tz) * expandLevel;
                let rz = currX * sin + currZ * cos;
                return { p, z: rz };
            });
            
            photoRenderList.sort((a, b) => b.z - a.z); // è¿œåˆ°è¿‘
            photoRenderList.forEach(item => item.p.draw(ctx, sin, cos));

            // ç”»é¡¶éƒ¨çš„æ˜Ÿæ˜Ÿ
            drawStar(width/2, height/2 - 250 - expandLevel*50, 20, 10);

            requestAnimationFrame(animate);
        }

        function drawStar(cx, cy, r1, r2) {
             // ç®€å•çš„ç”»æ˜Ÿæ˜Ÿé€»è¾‘ï¼Œçœç•¥ç»†èŠ‚ä»¥å…ä»£ç å¤ªé•¿
             ctx.save();
             ctx.beginPath();
             ctx.translate(cx, cy);
             ctx.fillStyle = "gold";
             ctx.shadowBlur = 20;
             ctx.shadowColor = "gold";
             ctx.arc(0,0, 8, 0, Math.PI*2);
             ctx.fill();
             ctx.restore();
        }

        // === äº¤äº’é€»è¾‘ ===

        // 1. é¼ æ ‡/è§¦æ‘¸ æ—‹è½¬é€»è¾‘
        canvas.addEventListener('mousedown', e => {
            isDragging = true;
            lastX = e.clientX;
        });
        window.addEventListener('mousemove', e => {
            if (isDragging) {
                let delta = e.clientX - lastX;
                rotationY += delta * 0.005;
                lastX = e.clientX;
            }
        });
        window.addEventListener('mouseup', () => isDragging = false);

        canvas.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                isDragging = true;
                lastX = e.touches[0].clientX;
            } else if (e.touches.length === 2) {
                // åŒæŒ‡è®°å½•åˆå§‹è·ç¦»
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                initialPinchDist = Math.sqrt(dx*dx + dy*dy);
            }
        });

        canvas.addEventListener('touchmove', e => {
            e.preventDefault(); // é˜²æ­¢æ»šåŠ¨å±å¹•
            if (e.touches.length === 1 && isDragging) {
                let delta = e.touches[0].clientX - lastX;
                rotationY += delta * 0.005;
                lastX = e.touches[0].clientX;
            } else if (e.touches.length === 2) {
                // åŒæŒ‡ç¼©æ”¾æ£€æµ‹
                let dx = e.touches[0].clientX - e.touches[1].clientX;
                let dy = e.touches[0].clientY - e.touches[1].clientY;
                let currentDist = Math.sqrt(dx*dx + dy*dy);
                
                if (currentDist - initialPinchDist > 50) {
                    targetExpandLevel = 1; // å¼ å¼€
                } else if (currentDist - initialPinchDist < -50) {
                    targetExpandLevel = 0; // æ”¶èµ·
                }
            }
        }, { passive: false });
        
        window.addEventListener('touchend', () => isDragging = false);

        // 2. ç‚¹å‡»ç…§ç‰‡é€»è¾‘
        function checkPhotoClick(mx, my) {
            // åªæœ‰å±•å¼€çŠ¶æ€æ‰å…è®¸ç‚¹å‡»ç…§ç‰‡
            if (targetExpandLevel < 0.5) return;

            // å€’åºæ£€æµ‹ï¼ˆå…ˆæ£€æµ‹æœ€ä¸Šé¢çš„ï¼‰
            // æˆ‘ä»¬éœ€è¦é‡æ–°ç®—ä¸€æ¬¡å±å¹•åæ ‡ï¼Œæˆ–è€…åœ¨drawé‡Œå­˜ä¸‹æ¥ã€‚
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œå¤ç”¨ photos æ•°ç»„ï¼Œæ³¨æ„æ­¤æ—¶ photos æ²¡æœ‰æŒ‰ z æ’åºï¼Œå¯èƒ½ç‚¹åˆ°åé¢çš„ã€‚
            // ä½†å› ä¸ºç…§ç‰‡æ•£å¼€äº†ï¼Œé‡å æ¦‚ç‡ä½ã€‚
            
            for (let p of photos) {
                // ç®€å•çš„çŸ©å½¢ç¢°æ’æˆ–è€…è·ç¦»æ£€æµ‹
                // å› ä¸ºåšäº† photoScaleï¼Œç‚¹å‡»åŒºåŸŸä¹Ÿè¦ç›¸åº”è°ƒæ•´
                let dist = Math.hypot(mx - p.screenX, my - p.screenY);
                if (dist < p.screenSize/2 + 10) {
                    showLightbox(p.img.src);
                    return true;
                }
            }
            return false;
        }

        canvas.addEventListener('click', e => {
            checkPhotoClick(e.clientX, e.clientY);
        });
        canvas.addEventListener('touchstart', e => {
            if(e.touches.length === 1) {
                // ç¨å¾®å»¶æ—¶ä¸€ç‚¹ï¼ŒåŒºåˆ†ç‚¹å‡»å’Œæ»‘åŠ¨
                let t = e.touches[0];
                checkPhotoClick(t.clientX, t.clientY);
            }
        });

        // 3. ç¯ç®±é€»è¾‘
        function showLightbox(src) {
            lightboxImg.src = src;
            lightbox.classList.add('active');
        }
        lightbox.addEventListener('click', () => {
            lightbox.classList.remove('active');
        });
        document.querySelector('.close-btn').addEventListener('click', () => {
            lightbox.classList.remove('active');
        });

        // 4. ç”µè„‘ç«¯ fallback æŒ‰é’®
        if (!('ontouchstart' in window)) {
            document.getElementById('desktopCtrl').style.display = 'block';
            document.getElementById('toggleBtn').addEventListener('click', () => {
                targetExpandLevel = targetExpandLevel === 0 ? 1 : 0;
            });
        }

        // å¼€å§‹
        preloadImages();

    </script>
</body>

</html>
